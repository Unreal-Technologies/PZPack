local containerTypeDef = {
    ["basic_crate"] = {
        kitType = "Carpentry",
        recipeName = "Crate",
        sprites = {
            [1] = "containers_0", [2] = "containers_1", [3] = "containers_2", [4] = "containers_3",
            [5] = "containers_4", [6] = "containers_5", [7] = "containers_6", [8] = "containers_7"
        }
    },
    ["white_crate"] = {
        kitType = "Carpentry",
        recipeName = "White Crate",
        sprites = {
            [1] = "containers_8", [2] = "containers_9", [3] = "containers_10", [4] = "containers_11",
            [5] = "containers_12", [6] = "containers_13", [7] = "containers_14", [8] = "containers_15"
        }
    },
    ["grey_crate"] = {
        kitType = "Carpentry",
        recipeName = "Grey Crate",
        sprites = {
            [1] = "containers_16", [2] = "containers_17", [3] = "containers_18", [4] = "containers_19",
            [5] = "containers_20", [6] = "containers_21", [7] = "containers_22", [8] = "containers_23"
        }
    },
    ["black_crate"] = {
        kitType = "Carpentry",
        recipeName = "Black Crate",
        sprites = {
            [1] = "containers_24", [2] = "containers_25", [3] = "containers_26", [4] = "containers_27",
            [5] = "containers_28", [6] = "containers_29", [7] = "containers_30", [8] = "containers_31"
        }
    },
    ["light_brown_crate"] = {
        kitType = "Carpentry",
        recipeName = "Light Brown Crate",
        sprites = {
            [1] = "containers_32", [2] = "containers_33", [3] = "containers_34", [4] = "containers_35",
            [5] = "containers_36", [6] = "containers_37", [7] = "containers_38", [8] = "containers_39"
        }
    },
    ["brown_crate"] = {
        kitType = "Carpentry",
        recipeName = "Brown Crate",
        sprites = {
            [1] = "containers_40", [2] = "containers_41", [3] = "containers_42", [4] = "containers_43",
            [5] = "containers_44", [6] = "containers_45", [7] = "containers_46", [8] = "containers_47"
        }
    },
    ["yellow_crate"] = {
        kitType = "Carpentry",
        recipeName = "Yellow Crate",
        sprites = {
            [1] = "containers_48", [2] = "containers_49", [3] = "containers_50", [4] = "containers_51",
            [5] = "containers_52", [6] = "containers_53", [7] = "containers_54", [8] = "containers_55"
        }
    },
    ["orange_crate"] = {
        kitType = "Carpentry",
        recipeName = "Orange Crate",
        sprites = {
            [1] = "containers_56", [2] = "containers_57", [3] = "containers_58", [4] = "containers_59",
            [5] = "containers_60", [6] = "containers_61", [7] = "containers_62", [8] = "containers_63"
        }
    },
    ["red_crate"] = {
        kitType = "Carpentry",
        recipeName = "Red Crate",
        sprites = {
            [1] = "containers_colored_0", [2] = "containers_colored_1", [3] = "containers_colored_2", [4] = "containers_colored_3",
            [5] = "containers_colored_4", [6] = "containers_colored_5", [7] = "containers_colored_6", [8] = "containers_colored_7"
        }
    },
    ["pink_crate"] = {
        kitType = "Carpentry",
        recipeName = "Pink Crate",
        sprites = {
            [1] = "containers_colored_8", [2] = "containers_colored_9", [3] = "containers_colored_10", [4] = "containers_colored_11",
            [5] = "containers_colored_12", [6] = "containers_colored_13", [7] = "containers_colored_14", [8] = "containers_colored_15"
        }
    },
    ["purple_crate"] = {
        kitType = "Carpentry",
        recipeName = "Purple Crate",
        sprites = {
            [1] = "containers_colored_16", [2] = "containers_colored_17", [3] = "containers_colored_18", [4] = "containers_colored_19",
            [5] = "containers_colored_20", [6] = "containers_colored_21", [7] = "containers_colored_22", [8] = "containers_colored_23"
        }
    },
    ["blue_crate"] = {
        kitType = "Carpentry",
        recipeName = "Blue Crate",
        sprites = {
            [1] = "containers_colored_24", [2] = "containers_colored_25", [3] = "containers_colored_26", [4] = "containers_colored_27",
            [5] = "containers_colored_28", [6] = "containers_colored_29", [7] = "containers_colored_30", [8] = "containers_colored_31"
        }
    },
    ["light_blue_crate"] = {
        kitType = "Carpentry",
        recipeName = "Light Blue Crate",
        sprites = {
            [1] = "containers_colored_32", [2] = "containers_colored_33", [3] = "containers_colored_34", [4] = "containers_colored_35",
            [5] = "containers_colored_36", [6] = "containers_colored_37", [7] = "containers_colored_38", [8] = "containers_colored_39"
        }
    },
    ["turquoise_crate"] = {
        kitType = "Carpentry",
        recipeName = "Turquoise Crate",
        sprites = {
            [1] = "containers_colored_40", [2] = "containers_colored_41", [3] = "containers_colored_42", [4] = "containers_colored_43",
            [5] = "containers_colored_44", [6] = "containers_colored_45", [7] = "containers_colored_46", [8] = "containers_colored_47"
        }
    },
    ["cyan_crate"] = {
        kitType = "Carpentry",
        recipeName = "Cyan Crate",
        sprites = {
            [1] = "containers_colored_48", [2] = "containers_colored_49", [3] = "containers_colored_50", [4] = "containers_colored_51",
            [5] = "containers_colored_52", [6] = "containers_colored_53", [7] = "containers_colored_54", [8] = "containers_colored_55"
        }
    },
    ["green_crate"] = {
        kitType = "Carpentry",
        recipeName = "Green Crate",
        sprites = {
            [1] = "containers_colored_56", [2] = "containers_colored_57", [3] = "containers_colored_58", [4] = "containers_colored_59",
            [5] = "containers_colored_60", [6] = "containers_colored_61", [7] = "containers_colored_62", [8] = "containers_colored_63"
        }
    },
    ["white_refrigerator"] = {
        kitType = "Electrical",
        recipeName = "White Refrigerator",
        sprites = {
            [1] = "refrigerators_01_0", [2] = "refrigerators_01_4", [3] = "refrigerators_01_8", [4] = "refrigerators_01_12",
            [5] = "refrigerators_01_16", [6] = "refrigerators_01_20", [7] = "refrigerators_01_24", [8] = "refrigerators_01_28"
        }
    },
    ["plain_refrigerator"] = {
        kitType = "Electrical",
        recipeName = "Plain Refrigerator",
        sprites = {
            [1] = "refrigerators_01_32", [2] = "refrigerators_01_36", [3] = "refrigerators_01_40", [4] = "refrigerators_01_44",
            [5] = "refrigerators_01_48", [6] = "refrigerators_01_52", [7] = "refrigerators_01_56", [8] = "refrigerators_01_60"
        }
    },
    ["steel_refrigerator"] = {
        kitType = "Electrical",
        recipeName = "Steel Refrigerator",
        sprites = {
            [1] = "refrigerators_02_0", [2] = "refrigerators_02_4", [3] = "refrigerators_02_8", [4] = "refrigerators_02_12",
            [5] = "refrigerators_02_16", [6] = "refrigerators_02_20", [7] = "refrigerators_02_24", [8] = "refrigerators_02_28"
        }
    },
    ["blue_refrigerator"] = {
        kitType = "Electrical",
        recipeName = "Blue Refrigerator",
        sprites = {
            [1] = "refrigerators_02_32", [2] = "refrigerators_02_36", [3] = "refrigerators_02_40", [4] = "refrigerators_02_44",
            [5] = "refrigerators_02_48", [6] = "refrigerators_02_52", [7] = "refrigerators_02_56", [8] = "refrigerators_02_60"
        }
    },
    ["green_refrigerator"] = {
        kitType = "Electrical",
        recipeName = "Green Refrigerator",
        sprites = {
            [1] = "refrigerators_03_0", [2] = "refrigerators_03_4", [3] = "refrigerators_03_8", [4] = "refrigerators_03_12",
            [5] = "refrigerators_03_16", [6] = "refrigerators_03_20", [7] = "refrigerators_03_24", [8] = "refrigerators_03_28"
        }
    },
    ["red_refrigerator"] = {
        kitType = "Electrical",
        recipeName = "Red Refrigerator",
        sprites = {
            [1] = "refrigerators_03_32", [2] = "refrigerators_03_36", [3] = "refrigerators_03_40", [4] = "refrigerators_03_44",
            [5] = "refrigerators_03_48", [6] = "refrigerators_03_52", [7] = "refrigerators_03_56", [8] = "refrigerators_03_60"
        }
    },
    ["military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Military Crate",
        sprites = {
            [1] = "containers_military_0", [2] = "containers_military_1", [3] = "containers_military_2", [4] = "containers_military_3",
            [5] = "containers_military_4", [6] = "containers_military_5", [7] = "containers_military_6", [8] = "containers_military_7"
        }
    },
    ["white_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "White Military Crate",
        sprites = {
            [1] = "containers_military_8", [2] = "containers_military_9", [3] = "containers_military_10", [4] = "containers_military_11",
            [5] = "containers_military_12", [6] = "containers_military_13", [7] = "containers_military_14", [8] = "containers_military_15"
        }
    },
    ["grey_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Grey Military Crate",
        sprites = {
            [1] = "containers_military_16", [2] = "containers_military_17", [3] = "containers_military_18", [4] = "containers_military_19",
            [5] = "containers_military_20", [6] = "containers_military_21", [7] = "containers_military_22", [8] = "containers_military_23"
        }
    },
    ["black_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Black Military Crate",
        sprites = {
            [1] = "containers_military_24", [2] = "containers_military_25", [3] = "containers_military_26", [4] = "containers_military_27",
            [5] = "containers_military_28", [6] = "containers_military_29", [7] = "containers_military_30", [8] = "containers_military_31"
        }
    },
    ["brown_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Brown Military Crate",
        sprites = {
            [1] = "containers_military_32", [2] = "containers_military_33", [3] = "containers_military_34", [4] = "containers_military_35",
            [5] = "containers_military_36", [6] = "containers_military_37", [7] = "containers_military_38", [8] = "containers_military_39"
        }
    },
    ["light_brown_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Light Brown Military Crate",
        sprites = {
            [1] = "containers_military_40", [2] = "containers_military_41", [3] = "containers_military_42", [4] = "containers_military_43",
            [5] = "containers_military_44", [6] = "containers_military_45", [7] = "containers_military_46", [8] = "containers_military_47"
        }
    },
    ["blue_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Blue Military Crate",
        sprites = {
            [1] = "containers_military_48", [2] = "containers_military_49", [3] = "containers_military_50", [4] = "containers_military_51",
            [5] = "containers_military_52", [6] = "containers_military_53", [7] = "containers_military_54", [8] = "containers_military_55"
        }
    },
    ["light_blue_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Light Blue Military Crate",
        sprites = {
            [1] = "containers_military_56", [2] = "containers_military_57", [3] = "containers_military_58", [4] = "containers_military_59",
            [5] = "containers_military_60", [6] = "containers_military_61", [7] = "containers_military_62", [8] = "containers_military_63"
        }
    },
    ["turquoise_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Turquoise Military Crate",
        sprites = {
            [1] = "containers_military_64", [2] = "containers_military_65", [3] = "containers_military_66", [4] = "containers_military_67",
            [5] = "containers_military_68", [6] = "containers_military_69", [7] = "containers_military_70", [8] = "containers_military_71"
        }
    },
    ["cyan_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Cyan Military Crate",
        sprites = {
            [1] = "containers_military_72", [2] = "containers_military_73", [3] = "containers_military_74", [4] = "containers_military_75",
            [5] = "containers_military_76", [6] = "containers_military_77", [7] = "containers_military_78", [8] = "containers_military_79"
        }
    },
    ["purple_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Purple Military Crate",
        sprites = {
            [1] = "containers_military_80", [2] = "containers_military_81", [3] = "containers_military_82", [4] = "containers_military_83",
            [5] = "containers_military_84", [6] = "containers_military_85", [7] = "containers_military_86", [8] = "containers_military_87"
        }
    },
    ["pink_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Pink Military Crate",
        sprites = {
            [1] = "containers_military_88", [2] = "containers_military_89", [3] = "containers_military_90", [4] = "containers_military_91",
            [5] = "containers_military_92", [6] = "containers_military_93", [7] = "containers_military_94", [8] = "containers_military_95"
        }
    },
    ["green_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Green Military Crate",
        sprites = {
            [1] = "containers_military_96", [2] = "containers_military_97", [3] = "containers_military_98", [4] = "containers_military_99",
            [5] = "containers_military_100", [6] = "containers_military_101", [7] = "containers_military_102", [8] = "containers_military_103"
        }
    },
    ["yellow_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Yellow Military Crate",
        sprites = {
            [1] = "containers_military_104", [2] = "containers_military_105", [3] = "containers_military_106", [4] = "containers_military_107",
            [5] = "containers_military_108", [6] = "containers_military_109", [7] = "containers_military_110", [8] = "containers_military_111"
        }
    },
    ["orange_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Orange Military Crate",
        sprites = {
            [1] = "containers_military_112", [2] = "containers_military_113", [3] = "containers_military_114", [4] = "containers_military_115",
            [5] = "containers_military_116", [6] = "containers_military_117", [7] = "containers_military_118", [8] = "containers_military_119"
        }
    },
    ["red_military_crate"] = {
        kitType = "Metalworking",
        recipeName = "Red Military Crate",
        sprites = {
            [1] = "containers_military_120", [2] = "containers_military_121", [3] = "containers_military_122", [4] = "containers_military_123",
            [5] = "containers_military_124", [6] = "containers_military_125", [7] = "containers_military_126", [8] = "containers_military_127"
        }
    },
    ["military_locker"] = {
        kitType = "Metalworking",
        recipeName = "Military Locker",
        sprites = {
            [1] = "containers_military_2_0", [2] = "containers_military_2_2", [3] = "containers_military_2_4", [4] = "containers_military_2_6",
            [5] = "containers_military_2_16", [6] = "containers_military_2_18", [7] = "containers_military_2_20", [8] = "containers_military_2_22"
        }
    },
    ["small_military_locker"] = {
        kitType = "Metalworking",
        recipeName = "Small Military Locker",
        sprites = {
            [1] = "containers_military_2_32", [2] = "containers_military_2_36", [3] = "containers_military_2_40", [4] = "containers_military_2_44",
            [5] = "containers_military_2_48", [6] = "containers_military_2_52", [7] = "containers_military_2_56", [8] = "containers_military_2_60"
        }
    },
    ["small_chest"] = {
        kitType = "Metalworking",
        recipeName = "Small Chest",
        sprites = {
            [1] = "containers_military_2_64", [2] = "containers_military_2_68", [3] = "containers_military_2_72", [4] = "containers_military_2_76",
            [5] = "containers_military_2_80", [6] = "containers_military_2_84", [7] = "containers_military_2_88", [8] = "containers_military_2_92"
        }
    },
    ["half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Half Crate",
        sprites = {
            [1] = "containers_02_0", [2] = "containers_02_1", [3] = "containers_02_2", [4] = "containers_02_3",
            [5] = "containers_02_4", [6] = "containers_02_5", [7] = "containers_02_6", [8] = "containers_02_7"
        }
    },
    ["white_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "White Half Crate",
        sprites = {
            [1] = "containers_02_8", [2] = "containers_02_9", [3] = "containers_02_10", [4] = "containers_02_11",
            [5] = "containers_02_12", [6] = "containers_02_13", [7] = "containers_02_14", [8] = "containers_02_15"
        }
    },
    ["grey_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Grey Half Crate",
        sprites = {
            [1] = "containers_02_16", [2] = "containers_02_17", [3] = "containers_02_18", [4] = "containers_02_19",
            [5] = "containers_02_20", [6] = "containers_02_21", [7] = "containers_02_22", [8] = "containers_02_23"
        }
    },
    ["black_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Black Half Crate",
        sprites = {
            [1] = "containers_02_24", [2] = "containers_02_25", [3] = "containers_02_26", [4] = "containers_02_27",
            [5] = "containers_02_28", [6] = "containers_02_29", [7] = "containers_02_30", [8] = "containers_02_31"
        }
    },
    ["light_brown_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Light Brown Half Crate",
        sprites = {
            [1] = "containers_02_32", [2] = "containers_02_33", [3] = "containers_02_34", [4] = "containers_02_35",
            [5] = "containers_02_36", [6] = "containers_02_37", [7] = "containers_02_38", [8] = "containers_02_39"
        }
    },
    ["brown_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Brown Half Crate",
        sprites = {
            [1] = "containers_02_40", [2] = "containers_02_41", [3] = "containers_02_42", [4] = "containers_02_43",
            [5] = "containers_02_44", [6] = "containers_02_45", [7] = "containers_02_46", [8] = "containers_02_47"
        }
    },
    ["yellow_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Yellow Half Crate",
        sprites = {
            [1] = "containers_02_48", [2] = "containers_02_49", [3] = "containers_02_50", [4] = "containers_02_51",
            [5] = "containers_02_52", [6] = "containers_02_53", [7] = "containers_02_54", [8] = "containers_02_55"
        }
    },
    ["orange_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Orange Half Crate",
        sprites = {
            [1] = "containers_02_56", [2] = "containers_02_57", [3] = "containers_02_58", [4] = "containers_02_59",
            [5] = "containers_02_60", [6] = "containers_02_61", [7] = "containers_02_62", [8] = "containers_02_63"
        }
    },
    ["red_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Red Half Crate",
        sprites = {
            [1] = "containers_02_64", [2] = "containers_02_65", [3] = "containers_02_66", [4] = "containers_02_67",
            [5] = "containers_02_68", [6] = "containers_02_69", [7] = "containers_02_70", [8] = "containers_02_71"
        }
    },
    ["pink_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Pink Half Crate",
        sprites = {
            [1] = "containers_02_72", [2] = "containers_02_73", [3] = "containers_02_74", [4] = "containers_02_75",
            [5] = "containers_02_76", [6] = "containers_02_77", [7] = "containers_02_78", [8] = "containers_02_79"
        }
    },
    ["purple_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Purple Half Crate",
        sprites = {
            [1] = "containers_02_80", [2] = "containers_02_81", [3] = "containers_02_82", [4] = "containers_02_83",
            [5] = "containers_02_84", [6] = "containers_02_85", [7] = "containers_02_86", [8] = "containers_02_87"
        }
    },
    ["blue_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Blue Half Crate",
        sprites = {
            [1] = "containers_02_88", [2] = "containers_02_89", [3] = "containers_02_90", [4] = "containers_02_91",
            [5] = "containers_02_92", [6] = "containers_02_93", [7] = "containers_02_94", [8] = "containers_02_95"
        }
    },
    ["light_blue_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Light Blue Half Crate",
        sprites = {
            [1] = "containers_02_96", [2] = "containers_02_97", [3] = "containers_02_98", [4] = "containers_02_99",
            [5] = "containers_02_100", [6] = "containers_02_101", [7] = "containers_02_102", [8] = "containers_02_103"
        }
    },
    ["turquoise_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Turquoise Half Crate",
        sprites = {
            [1] = "containers_02_104", [2] = "containers_02_105", [3] = "containers_02_106", [4] = "containers_02_107",
            [5] = "containers_02_108", [6] = "containers_02_109", [7] = "containers_02_110", [8] = "containers_02_111"
        }
    },
    ["cyan_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Cyan Half Crate",
        sprites = {
            [1] = "containers_02_112", [2] = "containers_02_113", [3] = "containers_02_114", [4] = "containers_02_115",
            [5] = "containers_02_116", [6] = "containers_02_117", [7] = "containers_02_118", [8] = "containers_02_119"
        }
    },
    ["green_half_crate"] = {
        kitType = "Carpentry",
        recipeName = "Green Half Crate",
        sprites = {
            [1] = "containers_02_120", [2] = "containers_02_121", [3] = "containers_02_122", [4] = "containers_02_123",
            [5] = "containers_02_124", [6] = "containers_02_125", [7] = "containers_02_126", [8] = "containers_02_127"
        }
    },
    ["metal_crate"] = {
        kitType = "Metalworking",
        recipeName = "Metal Crate",
        sprites = {
            [1] = "containers_03_0", [2] = "containers_03_4", [3] = "containers_03_8", [4] = "containers_03_12",
            [5] = "containers_03_16", [6] = "containers_03_20", [7] = "containers_03_24", [8] = "containers_03_28"
        }
    },
    ["cardboard_box"] = {
        kitType = "Carpentry",
        recipeName = "Cardboard Box",
        sprites = {
            [1] = "containers_03_32", [2] = "containers_03_33", [3] = "containers_03_34", [4] = "containers_03_35",
            [5] = "containers_03_36", [6] = "containers_03_37", [7] = "containers_03_38", [8] = "containers_03_39"
        }
    },
    ["metal_cabinet"] = {
        kitType = "Metalworking",
        recipeName = "Metal Cabinet",
        sprites = {
            [1] = "containers_03_40", [2] = "containers_03_44", [3] = "containers_03_48", [4] = "containers_03_52",
            [5] = "containers_03_56", [6] = "containers_03_60", [7] = "containers_03_64", [8] = "containers_03_68"
        }
    },
    ["ice_freezer"] = {
        kitType = "Electrical",
        recipeName = "Ice Freezer",
        sprites = {
            [1] = "refrigerators_04_0", [2] = "refrigerators_04_2", [3] = "refrigerators_04_4", [4] = "refrigerators_04_6",
            [5] = "refrigerators_04_8", [6] = "refrigerators_04_10", [7] = "refrigerators_04_12", [8] = "refrigerators_04_14"
        }
    }
}

local containerMapping = {}
for containerType, typeData in pairs(containerTypeDef) do
    for tier, spriteName in pairs(typeData.sprites) do
        containerMapping[spriteName] = {
            tier = tier,
            kitType = typeData.kitType,
            group = containerType
        }
    end
end

local tierCapacities = {
    [1] = 100, [2] = 250, [3] = 500, [4] = 750,
    [5] = 1000, [6] = 2000, [7] = 5000, [8] = 10000
}

local skillRequirements = {
    ["Carpentry"] = {
        [2] = 3, [3] = 4, [4] = 6, [5] = 7,
        [6] = 8, [7] = 9, [8] = 10
    },
    ["Metalworking"] = {
        [2] = 3, [3] = 4, [4] = 6, [5] = 7,
        [6] = 8, [7] = 9, [8] = 10
    },
    ["Electrical"] = {
        [2] = 3, [3] = 4, [4] = 6, [5] = 7,
        [6] = 8, [7] = 9, [8] = 10
    }
}

local containerSpriteMap = {}

local paintToColorMapping = {
    ["PaintRed"] = "red",
    ["PaintBlue"] = "blue", 
    ["PaintGreen"] = "green",
    ["PaintYellow"] = "yellow",
    ["PaintOrange"] = "orange",
    ["PaintPink"] = "pink",
    ["PaintPurple"] = "purple",
    ["PaintCyan"] = "cyan",
    ["PaintTurquoise"] = "turquoise",
    ["PaintLightBlue"] = "light_blue",
    ["PaintLightBrown"] = "light_brown",
    ["PaintBrown"] = "brown",
    ["PaintBlack"] = "black",
    ["PaintWhite"] = "white",
    ["PaintGrey"] = "grey"
}

local baseToPaintableMapping = {
    ["basic_crate"] = {
        "red_crate", "blue_crate", "green_crate", "yellow_crate", "orange_crate", 
        "pink_crate", "purple_crate", "cyan_crate", "turquoise_crate", "light_blue_crate",
        "light_brown_crate", "brown_crate", "black_crate", "white_crate", "grey_crate"
    },
    ["half_crate"] = {
        "red_half_crate", "blue_half_crate", "green_half_crate", "yellow_half_crate", "orange_half_crate",
        "pink_half_crate", "purple_half_crate", "cyan_half_crate", "turquoise_half_crate", "light_blue_half_crate",
        "light_brown_half_crate", "brown_half_crate", "black_half_crate", "white_half_crate", "grey_half_crate"
    },
    ["military_crate"] = {
        "red_military_crate", "blue_military_crate", "green_military_crate", "yellow_military_crate", "orange_military_crate",
        "pink_military_crate", "purple_military_crate", "cyan_military_crate", "turquoise_military_crate", "light_blue_military_crate",
        "light_brown_military_crate", "brown_military_crate", "black_military_crate", "white_military_crate", "grey_military_crate"
    }
}

local function setupContainerCapacities()
    if CContainersOverride and CContainersOverride.setCapacity then
        for spriteName, containerInfo in pairs(containerMapping) do
            local capacity = tierCapacities[containerInfo.tier]
            CContainersOverride.setCapacity(spriteName, capacity)
        end
        
        local ItemContainer_getType = {}
        function ItemContainer_getType.GetClass()
            local class, methodName = ItemContainer.class, "getType"
            local metatable = __classmetatables[class]
            local metatable__index = metatable.__index
            local original_function = metatable__index[methodName]
            metatable__index[methodName] = ItemContainer_getType.PatchClass(original_function)
        end
        
        function ItemContainer_getType.PatchClass(original_function)
            return function(self)
                local parent = self:getParent()
                if parent and instanceof(parent, "IsoObject") then
                    
                    if not containerSpriteMap[parent] then
                        local sprite = parent:getSprite()
                        if sprite then
                            local spriteName = sprite:getName()
                            if containerMapping[spriteName] then
                                containerSpriteMap[parent] = spriteName
                            end
                        end
                    end
                    
                    if containerSpriteMap[parent] then
                        return containerSpriteMap[parent]
                    end
                end
                
                return original_function(self)
            end
        end
        
        ItemContainer_getType.GetClass()
        
    else
        print("ERROR: CContainersOverride not available")
    end
end

local function setContainerSprite(worldObject, spriteName)
    if worldObject then
        containerSpriteMap[worldObject] = spriteName
    end
end

local function getUpgradeKitItemName(kitType, tier)
    return "CC." .. kitType .. "UpgradeKit" .. tier
end

local function checkUpgradeRequirements(player, kitType, nextTier)
    local playerObj = getSpecificPlayer(player)
    local inv = playerObj:getInventory()
    
    local kitItemName = getUpgradeKitItemName(kitType, nextTier)
    local hasKit = inv:getItemCount(kitItemName) > 0
    
    local requiredSkill = skillRequirements[kitType][nextTier]
    local skillPerk = kitType == "Carpentry" and Perks.Woodwork or 
                     kitType == "Metalworking" and Perks.MetalWelding or 
                     kitType == "Electrical" and Perks.Electricity
    local hasSkill = playerObj:getPerkLevel(skillPerk) >= requiredSkill
    
    return hasKit, hasSkill, kitItemName, requiredSkill, skillPerk
end

local function getTargetSpriteName(currentSpriteName, targetTier)
    local currentInfo = containerMapping[currentSpriteName]
    if not currentInfo then return nil end
    
    local group = containerTypeDef[currentInfo.group]
    return group.sprites[targetTier]
end

local function getBaseTypeFromContainer(containerType)
    if containerType:find("_crate$") and not containerType:find("half") and not containerType:find("military") then
        return "basic_crate"
    elseif containerType:find("half_crate$") then
        return "half_crate" 
    elseif containerType:find("military_crate$") then
        return "military_crate"
    end
    return nil
end

local function isPaintable(containerType)
    local baseType = getBaseTypeFromContainer(containerType)
    return baseType ~= nil and baseToPaintableMapping[baseType] ~= nil
end

local function getPaintedSprite(currentSpriteName, paintType)
    local currentInfo = containerMapping[currentSpriteName]
    if not currentInfo then return nil end
    
    local baseType = getBaseTypeFromContainer(currentInfo.group)
    if not baseType then return nil end
    
    local colorName = paintToColorMapping[paintType]
    if not colorName then return nil end
    
    local targetContainerType = colorName .. "_" .. baseType:gsub("basic_", "")
    
    if containerTypeDef[targetContainerType] then
        local targetGroup = containerTypeDef[targetContainerType]
        return targetGroup.sprites[currentInfo.tier]
    end
    
    return nil
end

local function checkPaintRequirements(player, paintType)
    local playerObj = getSpecificPlayer(player)
    local inv = playerObj:getInventory()
    
    local hasPaintbrush = inv:getFirstTagRecurse("Paintbrush") ~= nil
    local paintCan = inv:getFirstTypeRecurse(paintType)
    local hasPaint = paintCan ~= nil and paintCan:getCurrentUses() > 0
    
    return hasPaintbrush, hasPaint
end

function createUpgradeContextMenu(player, context, worldobjects, test)
    local playerObj = getSpecificPlayer(player)
    
    local selectedValue = SandboxVars.CustomizableRecipes.CContainers
    
    if selectedValue < 2 then
        return
    end
    
    local maxAllowedTier = math.min(selectedValue - 1, 8)
    
    for i, v in ipairs(worldobjects) do
        local worldObject = v
        
        if worldObject:getContainer() then
            local sprite = worldObject:getSprite()
            if sprite then
                local spriteName = sprite:getName()
                local containerInfo = containerMapping[spriteName]
                
                if containerInfo then
                    local currentTier = containerInfo.tier
                    local kitType = containerInfo.kitType
                    local currentCapacity = tierCapacities[currentTier]
                    
                    setContainerSprite(worldObject, spriteName)
                    
                    if currentTier < maxAllowedTier then
                        local upgradeSubmenu = context:addOption("Upgrade", playerObj, nil)
                        local subMenu = ISContextMenu:getNew(context)
                        context:addSubMenu(upgradeSubmenu, subMenu)
                        
                        for targetTier = currentTier + 1, maxAllowedTier do
                            local targetSpriteName = getTargetSpriteName(spriteName, targetTier)
                            
                            if targetSpriteName and containerMapping[targetSpriteName] then
                                local targetCapacity = tierCapacities[targetTier]
                                local hasKit, hasSkill, kitItemName, requiredSkill, skillPerk = checkUpgradeRequirements(player, kitType, targetTier)
                                
                                if hasKit and hasSkill then
                                    local optionText = "Tier " .. targetTier
                                    
                                    subMenu:addOption(optionText, playerObj, function()
                                        local inv = playerObj:getInventory()
                                        
                                        local upgradeKit = inv:getFirstTypeRecurse(kitItemName)
                                        if upgradeKit then
                                            inv:DoRemoveItem(upgradeKit)
                                            
                                            worldObject:setSprite(targetSpriteName)
                                            setContainerSprite(worldObject, targetSpriteName)
                                        else
                                            print("Upgrade kit not found")
                                        end
                                    end)
                                else
                                    local optionText = "Tier " .. targetTier .. " (Locked)"
                                    local option = subMenu:addOption(optionText, playerObj, function() end)
                                    option.notAvailable = true
                                    
                                    local tooltip = ISInventoryPaneContextMenu.addToolTip()
                                    option.toolTip = tooltip
                                    
                                    local missingRequirements = {}
                                    if not hasKit then
                                        table.insert(missingRequirements, kitType .. " Upgrade Kit Tier " .. targetTier)
                                    end
                                    if not hasSkill then
                                        local skillName = kitType == "Carpentry" and "Carpentry" or 
                                                         kitType == "Metalworking" and "Metalworking" or 
                                                         "Electrical"
                                        table.insert(missingRequirements, skillName .. " Level " .. requiredSkill)
                                    end
                                    
                                    tooltip.description = "Requires: " .. table.concat(missingRequirements, ", ")
                                end
                            end
                        end
                    end
                    
                    if isPaintable(containerInfo.group) then
                        local paintSubmenu = context:addOption("Paint", playerObj, nil)
                        local paintMenu = ISContextMenu:getNew(context)
                        context:addSubMenu(paintSubmenu, paintMenu)
                        
                        local availableColors = {
                            {name = "Red", paintType = "PaintRed"},
                            {name = "Blue", paintType = "PaintBlue"},
                            {name = "Green", paintType = "PaintGreen"},
                            {name = "Yellow", paintType = "PaintYellow"},
                            {name = "Orange", paintType = "PaintOrange"},
                            {name = "Pink", paintType = "PaintPink"},
                            {name = "Purple", paintType = "PaintPurple"},
                            {name = "Cyan", paintType = "PaintCyan"},
                            {name = "Turquoise", paintType = "PaintTurquoise"},
                            {name = "Light Blue", paintType = "PaintLightBlue"},
                            {name = "Light Brown", paintType = "PaintLightBrown"},
                            {name = "Brown", paintType = "PaintBrown"},
                            {name = "Black", paintType = "PaintBlack"},
                            {name = "White", paintType = "PaintWhite"},
                            {name = "Grey", paintType = "PaintGrey"}
                        }
                        
                        for _, color in ipairs(availableColors) do
                            local targetSprite = getPaintedSprite(spriteName, color.paintType)
                            
                            if targetSprite and containerMapping[targetSprite] and targetSprite ~= spriteName then
                                local hasPaintbrush, hasPaint = checkPaintRequirements(player, color.paintType)
                                
                                if hasPaintbrush and hasPaint then
                                    paintMenu:addOption(color.name, playerObj, function()
                                        local inv = playerObj:getInventory()
                                        
                                        local paintCan = inv:getFirstTypeRecurse(color.paintType)
                                        if paintCan then
                                            if paintCan:getCurrentUses() > 0 then
                                                paintCan:Use()
                                                
                                                worldObject:setSprite(targetSprite)
                                                setContainerSprite(worldObject, targetSprite)
                                            else
                                                print("Paint can is empty")
                                            end
                                        else
                                            print("Paint not found")
                                        end
                                    end)
                                else
                                    local optionText = color.name .. " (Locked)"
                                    local option = paintMenu:addOption(optionText, playerObj, function() end)
                                    option.notAvailable = true
                                    
                                    local tooltip = ISInventoryPaneContextMenu.addToolTip()
                                    option.toolTip = tooltip
                                    
                                    local missingRequirements = {}
                                    if not hasPaintbrush then
                                        table.insert(missingRequirements, "Paintbrush")
                                    end
                                    if not hasPaint then
                                        table.insert(missingRequirements, color.name .. " Paint")
                                    end
                                    
                                    tooltip.description = "Requires: " .. table.concat(missingRequirements, ", ")
                                end
                            end
                        end
                    end
                    
                    if currentTier >= maxAllowedTier then
                        local optionText = "Max Tier " .. currentTier .. " (Sandbox Limited)"
                        local option = context:addOption(optionText, playerObj, function() end)
                        option.notAvailable = true
                        
                        local tooltip = ISInventoryPaneContextMenu.addToolTip()
                        option.toolTip = tooltip
                        tooltip.description = "Upgrade limited by sandbox settings (Max Tier: " .. maxAllowedTier .. ")"
                    elseif currentTier == 8 then
                        local optionText = "Max Tier " .. currentTier .. " (Capacity: " .. currentCapacity .. ")"
                        local option = context:addOption(optionText, playerObj, function() end)
                        option.notAvailable = true
                    end
                    
                    break
                end
            end
        end
    end
end

function RecipeDetectionCContainer()
    local tiers = { "Tier 1", "Tier 2", "Tier 3", "Tier 4", "Tier 5", "Tier 6", "Tier 7", "Tier 8" }
    local upgradeKitTypes = { "Carpentry", "Metalworking", "Electrical" }
    local upgradeKitTiers = { 2, 3, 4, 5, 6, 7, 8 }

    local selectedValue = SandboxVars.CustomizableRecipes.CContainers

    local function addRecipe(recipeName)
        if not getPlayer():getKnownRecipes():contains(recipeName) then
            getPlayer():getKnownRecipes():add(recipeName)
        end
    end

    local function removeRecipe(recipeName)
        if getPlayer():getKnownRecipes():contains(recipeName) then
            getPlayer():getKnownRecipes():remove(recipeName)
        end
    end

    local recipesToRemove = {}
    
    for containerType, typeData in pairs(containerTypeDef) do
        for _, tier in ipairs(tiers) do
            local recipeName = "Craft " .. typeData.recipeName .. " " .. tier
            table.insert(recipesToRemove, recipeName)
        end
    end
    
    for _, kitType in ipairs(upgradeKitTypes) do
        for _, tier in ipairs(upgradeKitTiers) do
            local recipeName = "Craft " .. kitType .. " Upgrade Kit Tier " .. tier
            table.insert(recipesToRemove, recipeName)
        end
    end

    for _, recipeName in ipairs(recipesToRemove) do
        removeRecipe(recipeName)
        if getPlayer():HasTrait("ingenuitive") then
            removeRecipe(recipeName)
        end
    end

    if selectedValue >= 2 then
        local maxAllowedTier = math.min(selectedValue - 1, #tiers)
        
        for containerType, typeData in pairs(containerTypeDef) do
            for j = 1, maxAllowedTier do
                local recipeName = "Craft " .. typeData.recipeName .. " " .. tiers[j]
                addRecipe(recipeName)
            end
        end
        
        for _, kitType in ipairs(upgradeKitTypes) do
            for _, tier in ipairs(upgradeKitTiers) do
                if tier <= maxAllowedTier then
                    local recipeName = "Craft " .. kitType .. " Upgrade Kit Tier " .. tier
                    addRecipe(recipeName)
                end
            end
        end
    end
end

Events.OnGameStart.Add(setupContainerCapacities)
Events.OnGameStart.Add(RecipeDetectionCContainer)

Events.OnFillWorldObjectContextMenu.Add(createUpgradeContextMenu)

Events.OnLoad.Add(RecipeDetectionCContainer)
Events.OnCreatePlayer.Add(RecipeDetectionCContainer)